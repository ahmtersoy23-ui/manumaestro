// ManuMaestro - Production Request Management System
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String                    @id @default(uuid())
  email             String                    @unique
  name              String
  passwordHash      String
  role              UserRole                  @default(OPERATOR)
  isActive          Boolean                   @default(true)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt

  // Relations
  permissions       UserMarketplacePermission[]
  requests          ProductionRequest[]
  createdMarketplaces Marketplace[]           @relation("CreatedBy")
  auditLogs         AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}

// ============================================
// MARKETPLACE MANAGEMENT
// ============================================

model Marketplace {
  id                String              @id @default(uuid())
  name              String              // "Amazon US", "Wayfair UK", "Custom Market"
  code              String              @unique // "AMZN_US", "WAYFAIR_UK", "CUSTOM_01"
  marketplaceType   MarketplaceType
  region            String              // "US", "EU", "UK", "CA", "AU", "ZA", "NL", "TR", "Custom"
  isCustom          Boolean             @default(false)
  isActive          Boolean             @default(true)
  colorTag          String?             // Hex color for UI
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdById       String?

  // Relations
  createdBy         User?               @relation("CreatedBy", fields: [createdById], references: [id])
  permissions       UserMarketplacePermission[]
  requests          ProductionRequest[]

  @@map("marketplaces")
}

enum MarketplaceType {
  AMAZON
  WAYFAIR
  TAKEALOT
  BOL
  TRENDYOL
  ETSY
  CUSTOM
  OTHER
}

// ============================================
// USER PERMISSIONS
// ============================================

model UserMarketplacePermission {
  id              String       @id @default(uuid())
  userId          String
  marketplaceId   String
  canView         Boolean      @default(true)
  canEdit         Boolean      @default(true)
  createdAt       DateTime     @default(now())

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplace     Marketplace  @relation(fields: [marketplaceId], references: [id], onDelete: Cascade)

  @@unique([userId, marketplaceId])
  @@map("user_marketplace_permissions")
}

// ============================================
// PRODUCT REFERENCE (From existing DB)
// ============================================
// Note: This connects to existing products table in another database
// We'll use views or direct queries for this

// ============================================
// PRODUCTION REQUESTS
// ============================================

model ProductionRequest {
  id                String       @id @default(uuid())
  iwasku            String       // Reference to products.iwasku
  productName       String       // Cached from products
  productCategory   String       // Cached from products
  productSize       Float?       // Cached from products - desi (volumetric size)
  marketplaceId     String
  quantity          Int
  producedQuantity  Int?         // Quantity actually produced by manufacturer
  requestDate       DateTime     @default(now())
  status            RequestStatus @default(REQUESTED)
  workflowStage     WorkflowStage? // For furniture category workflow tracking
  entryType         EntryType
  notes             String?      // Operator notes
  manufacturerNotes String?      // Manufacturer production notes
  enteredById       String
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  marketplace       Marketplace  @relation(fields: [marketplaceId], references: [id])
  enteredBy         User         @relation(fields: [enteredById], references: [id])

  @@index([iwasku])
  @@index([marketplaceId])
  @@index([requestDate])
  @@index([status])
  @@index([workflowStage])
  @@index([productCategory, workflowStage])
  @@map("production_requests")
}

enum RequestStatus {
  REQUESTED
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

enum EntryType {
  MANUAL
  EXCEL
}

enum WorkflowStage {
  REQUESTED       // Initial request received
  CUTTING         // Material cutting stage
  ASSEMBLY        // Assembly/construction stage
  QUALITY_CHECK   // Quality control
  PACKAGING       // Packaging stage
  READY_TO_SHIP   // Ready for shipment
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id            String       @id @default(uuid())
  userId        String
  userName      String       // Cached for performance
  userEmail     String       // Cached for performance
  action        AuditAction
  entityType    String?      // e.g., "ProductionRequest", "Marketplace"
  entityId      String?      // ID of the affected entity
  description   String       // Human-readable description
  metadata      Json?        // Additional data (old/new values, etc.)
  ipAddress     String?
  createdAt     DateTime     @default(now())

  // Relations
  user          User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

enum AuditAction {
  CREATE_REQUEST
  UPDATE_REQUEST
  DELETE_REQUEST
  CREATE_MARKETPLACE
  UPDATE_MARKETPLACE
  DELETE_MARKETPLACE
  UPDATE_PRODUCTION
  LOGIN
  LOGOUT
  BULK_UPLOAD
  EXPORT_DATA
}
